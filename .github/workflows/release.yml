name: Build and Release MineMusic

on:
  push:
    tags:
      - 'v*'  # æ¨é€ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

env:
  FLUTTER_VERSION: '3.35.2'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    # 2. è®¾ç½® Java ç¯å¢ƒ
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    # 3. è®¾ç½® Flutter ç¯å¢ƒ
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        
    # 4. å®‰è£…ä¾èµ–
    - name: Install dependencies
      run: flutter pub get
      
    # 5. ä»£ç åˆ†æ
    - name: Analyze code
      run: flutter analyze || echo "ä»£ç åˆ†ææœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ„å»º"
      
    # 6. è§£ç  keystore æ–‡ä»¶
    - name: Decode keystore
      run: |
        echo '${{ secrets.KEY_STORE_BASE64 }}' | base64 --decode > android/app/keystore.jks
        
    # 7. åˆ›å»ºç­¾åé…ç½®æ–‡ä»¶
    - name: Create signing properties
      run: |
        cat << EOF > android/key.properties
        storePassword=${{ secrets.KEY_STORE_PASSWORD }}
        keyPassword=${{ secrets.KEY_PASSWORD }}
        keyAlias=${{ secrets.KEY_ALIAS }}
        storeFile=keystore.jks
        EOF
        
    # 8. æ„å»ºç­¾åçš„ APK - å®Œæ•´åŒ…ï¼ˆåŒ…å«æ‰€æœ‰æ¶æ„ï¼‰
    - name: Build signed APK - Universal
      run: flutter build apk --release --dart-define=LASTFM_API_KEY=${{ secrets.LASTFM_API_KEY }} --dart-define=LASTFM_SHARED_SECRET=${{ secrets.LASTFM_SHARED_SECRET }}

    # 9. æ„å»ºç­¾åçš„ APK - åˆ†æ¶æ„åŒ…
    - name: Build signed APK - Split per ABI
      run: flutter build apk --release --split-per-abi --dart-define=LASTFM_API_KEY=${{ secrets.LASTFM_API_KEY }} --dart-define=LASTFM_SHARED_SECRET=${{ secrets.LASTFM_SHARED_SECRET }}

    # 10. é‡å‘½å APK æ–‡ä»¶
    - name: Rename APK files
      run: |
        mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/MineMusic-universal.apk
        mv build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk build/app/outputs/flutter-apk/MineMusic-armeabi-v7a.apk
        mv build/app/outputs/flutter-apk/app-arm64-v8a-release.apk build/app/outputs/flutter-apk/MineMusic-arm64-v8a.apk

    # 11. åˆ›å»º GitHub Release
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        release_name: MineMusic ${{ github.ref_name }}
        body: |
          ğŸµ **MineMusic éŸ³ä¹æ’­æ”¾å™¨** ${{ github.ref_name }}

          ### â«ï¸ ç‰ˆæœ¬è¯´æ˜
          1. é‡æ–°è®¾è®¡äº†ä¸»é¡µå’Œæ’­æ”¾é¡µã€æ­Œè¯é¡µ
          2. é‡æ–°è®¾è®¡äº†å–è‰²é€»è¾‘
          3. æ·»åŠ äº†æ–°çš„å­—ä½“æ”¯æŒï¼šä½¿ç”¨Nunito + Noto Sans SCçš„æ–¹æ¡ˆ
          4. ä¿®å¤äº†ç©ºæŒ‡é’ˆå¼‚å¸¸é—®é¢˜ï¼Œç¡®ä¿åº”ç”¨åœ¨è¿è¡Œæ—¶ä¸ä¼šå´©æºƒ
          5. ä¿®å¤äº†å¾€æœŸé—ç•™çš„åˆå§‹åŒ–é—®é¢˜
          6.æ–°å¢äº†æ’­æ”¾é¡µé¢æŒ‰é’®çš„éœ‡åŠ¨äº¤äº’
          
          ### ğŸ“± åº”ç”¨ä¿¡æ¯
          - **åŒ…å**: com.example.minemusic
          - **ç‰ˆæœ¬**: ${{ github.ref_name }}
          - **Flutter**: ${{ env.FLUTTER_VERSION }}
          
          ### ğŸ“¦ ä¸‹è½½æ–‡ä»¶
          - **MineMusic-universal.apk**: å®Œæ•´åŒ…ï¼ˆåŒ…å«æ‰€æœ‰æ¶æ„ï¼Œä½“ç§¯è¾ƒå¤§ï¼‰
          - **MineMusic-arm64-v8a.apk**: ARM64 æ¶æ„ï¼ˆæ¨èï¼Œé€‚ç”¨äºå¤§å¤šæ•°ç°ä»£è®¾å¤‡ï¼‰
          - **MineMusic-armeabi-v7a.apk**: ARMv7 æ¶æ„ï¼ˆé€‚ç”¨äºæ—§è®¾å¤‡ï¼‰
          
          ### ğŸ“± æ¶æ„è¯´æ˜
          - **Universal**: åŒ…å«æ‰€æœ‰æ¶æ„ï¼Œå…¼å®¹æ€§æœ€å¥½ï¼Œä½†ä½“ç§¯æœ€å¤§
          - **arm64-v8a**: 64ä½ ARM æ¶æ„ï¼Œé€‚ç”¨äº 2016 å¹´åçš„å¤§å¤šæ•° Android è®¾å¤‡
          - **armeabi-v7a**: 32ä½ ARM æ¶æ„ï¼Œé€‚ç”¨äºè¾ƒæ—§çš„ Android è®¾å¤‡
          
          ### ğŸ¶ åŠŸèƒ½ç‰¹æ€§
          - æ”¯æŒ Subsonic API (Navidrome)
          - Material You åŠ¨æ€é…è‰²
          - å®Œæ•´çš„éŸ³ä¹æ’­æ”¾åŠŸèƒ½
          - æœ¬åœ°éŸ³ä¹åº“ç®¡ç†
          - æœç´¢å’Œæµè§ˆåŠŸèƒ½
          
          ### ğŸ“² å®‰è£…è¯´æ˜
          1. ä¸‹è½½ `MineMusic-universal.apk` æ–‡ä»¶
          2. åœ¨ Android è®¾ç½®ä¸­å…è®¸"å®‰è£…æœªçŸ¥æ¥æºåº”ç”¨"
          3. ç‚¹å‡» APK æ–‡ä»¶å®‰è£…
          4. æ‰“å¼€åº”ç”¨å¹¶è¿æ¥åˆ°ä½ çš„ Navidrome æœåŠ¡å™¨
          
          > ğŸ”’ æ­¤ç‰ˆæœ¬å·²ä½¿ç”¨æ•°å­—ç­¾åè®¤è¯
        draft: false
        prerelease: false
        files: |
          build/app/outputs/flutter-apk/MineMusic-universal.apk
          build/app/outputs/flutter-apk/MineMusic-arm64-v8a.apk
          build/app/outputs/flutter-apk/MineMusic-armeabi-v7a.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}