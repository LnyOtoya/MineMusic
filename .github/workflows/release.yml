name: Build and Release MineMusic

on:
  push:
    tags:
      - 'v*'  # æ¨é€ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  FLUTTER_VERSION: '3.35.2'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 2. è®¾ç½® Java ç¯å¢ƒ
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    # 3. è®¾ç½® Flutter ç¯å¢ƒ
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        
    # 4. å®‰è£…ä¾èµ–
    - name: Install dependencies
      run: flutter pub get
      
    # 5. ä»£ç åˆ†æ
    - name: Analyze code
      run: flutter analyze || echo "ä»£ç åˆ†ææœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ„å»º"
      
    # 6. è§£ç  keystore æ–‡ä»¶
    - name: Decode keystore
      run: |
        echo '${{ secrets.KEY_STORE_BASE64 }}' | base64 --decode > android/app/keystore.jks
        
    # 7. åˆ›å»ºç­¾åé…ç½®æ–‡ä»¶
    - name: Create signing properties
      run: |
        cat << EOF > android/key.properties
        storePassword=${{ secrets.KEY_STORE_PASSWORD }}
        keyPassword=${{ secrets.KEY_PASSWORD }}
        keyAlias=${{ secrets.KEY_ALIAS }}
        storeFile=keystore.jks
        EOF
        
    # 8. æ„å»ºç­¾åçš„ APK
    - name: Build signed APK
      run: flutter build apk --release
      
    # 9. æ„å»ºç­¾åçš„ App Bundle
    - name: Build signed App Bundle
      run: flutter build appbundle --release
      
    # 10. åˆ›å»º GitHub Release
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        release_name: MineMusic ${{ github.ref_name }}
        body: |
          ğŸµ **MineMusic éŸ³ä¹æ’­æ”¾å™¨** ${{ github.ref_name }}
          
          ### ğŸ“± åº”ç”¨ä¿¡æ¯
          - **åŒ…å**: com.example.minemusic
          - **ç‰ˆæœ¬**: ${{ github.ref_name }}
          - **Flutter**: ${{ env.FLUTTER_VERSION }}
          
          ### ğŸ“¦ ä¸‹è½½æ–‡ä»¶
          - **APK**: ç›´æ¥å®‰è£…åˆ° Android è®¾å¤‡
          - **AAB**: ç”¨äº Google Play å•†åº—å‘å¸ƒ
          
          ### ğŸ¶ åŠŸèƒ½ç‰¹æ€§
          - æ”¯æŒ Subsonic API (Navidrome)
          - Material You åŠ¨æ€é…è‰²
          - å®Œæ•´çš„éŸ³ä¹æ’­æ”¾åŠŸèƒ½
          - æœ¬åœ°éŸ³ä¹åº“ç®¡ç†
          - æœç´¢å’Œæµè§ˆåŠŸèƒ½
          
          ### ğŸ“² å®‰è£…è¯´æ˜
          1. ä¸‹è½½ `app-release.apk` æ–‡ä»¶
          2. åœ¨ Android è®¾ç½®ä¸­å…è®¸"å®‰è£…æœªçŸ¥æ¥æºåº”ç”¨"
          3. ç‚¹å‡» APK æ–‡ä»¶å®‰è£…
          4. æ‰“å¼€åº”ç”¨å¹¶è¿æ¥åˆ°ä½ çš„ Navidrome æœåŠ¡å™¨
          
          > ğŸ”’ æ­¤ç‰ˆæœ¬å·²ä½¿ç”¨æ•°å­—ç­¾åè®¤è¯
        draft: false
        prerelease: false
        files: |
          build/app/outputs/flutter-apk/app-release.apk
          build/app/outputs/bundle/release/app-release.aab
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}